<?xml version="1.0" encoding="UTF-8"?>
<project basedir="." default="init" name="Targets to index GBV data">

	<property file="gvi-ant-gbv.local.properties" />

	<import file="gvi-solrmarc-ant.xml" />

	<!-- Die Variablen definieren. -->
	<target name="init">
		<property name="data.collection" value="GVK" />
		<property name="base.dir" location="/data/input/gvi/gbv/current" />
		<property name="full.dir" location="${base.dir}/full" />
		<property name="full.log.dir" location="${full.dir}/log" />
		<property name="update.base.dir" location="${base.dir}/update" />
		<property name="update.dir" location="${update.base.dir}${date.dir}" />
		<property name="update.work.dir" location="${update.base.dir}/work" />
		<property name="update.log.dir" location="${update.base.dir}/log" />
	</target>

	<!-- Get Raw Data from FTP server -->
	<target name="download-updates-gbv" depends="init">
		<echo>Checking updates</echo>
		<ftp action="get" server="${ftp.server}" userid="${ftp.userid}" password="${ftp.password}" remotedir="${ftp.remotedir}" verbose="true" newer="true" preservelastmodified="true">
			<fileset dir="${update.dir}">
				<include name="gbv-catalog-update-*.mrc.tar.gz" />
				<include name="gbv-catalog-delete-*.txt" />
			</fileset>
		</ftp>
		<available property="updates.found" file="${update.dir}" />
	</target>

	<!-- Process current data set -->
	<target name="index-new-updates-gbv" depends="download-updates-gbv" if="updates.found">
		<fail> Unimplemented </fail>
	</target>

	<!-- Collect data sets and process them all together -->
	<target name="index-all-updates-gbv" depends="init">
		<delete dir="${update.work.dir}" quiet="false" failonerror="true" />
		<mkdir dir="${update.work.dir}" />
		<unpack_and_filter src="${update.base.dir}" dest="${update.work.dir}" />
		<solrmarc-index-dir src="${update.work.dir}" logdir="${update.log.dir}" basename="all_updates" />
		<solrmarc-delete-dir src="${update.work.dir}" logdir="${update.log.dir}" basename="all_deletes" />
	</target>

	<!-- Komplettabzug und Updates indexieren -->
	<target name="index-all-gbv" depends="init,init-index-date-for-delete">
      <solrmarc-index-dir src="${full.dir}" logdir="${full.log.dir}" basename="full" />
		<antcall target="index-all-updates-gbv" />
		<antcall target="delete-by-collection-and-index-date" />
	</target>

	<!-- Nur den Komplettabzug indexieren -->
	<target name="index-onlyFull-gbv" depends="init,init-index-date-for-delete">
      <solrmarc-index-dir src="${full.dir}" logdir="${full.log.dir}" basename="full" />
		<antcall target="delete-by-collection-and-index-date" />
	</target>

	<macrodef name="unpack_and_filter">
		<attribute name="src" />
		<attribute name="dest" />
		<sequential>
			<mkdir dir="@{dest}" />
				<untar dest="@{dest}" compression="gzip" >
					<fileset dir="@{src}" includes="*.tar.gz" />
			</untar>
			<!-- Cleanup 'DEL'files -->
			<echo> ! Check regex </echo>
			<replaceregexp match="^(?!(.*DE-601)).*\n" replace="" flags="gm" byline="false">
				<fileset dir="@{dest}" includes="*.txt" />
			</replaceregexp>
		</sequential>
	</macrodef>

</project>
