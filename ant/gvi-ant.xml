<?xml version="1.0" encoding="UTF-8"?>
<project basedir="." default="index-updates" name="GVI Jenkins">

    <property file="gvi-ant.local.properties"/>
    <property file="gvi-ant.properties"/>

    <path id="solrmarc.classpath">
        <pathelement location="${solrmarc.dist.path}/SolrMarc.jar"/>
    </path>
    
    <taskdef resource="net/sf/antcontrib/antlib.xml">
        <classpath>
            <pathelement location="${solrmarc.dist.path}/../ant/lib/ant-contrib-1.0b3.jar"/>
        </classpath>
    </taskdef>

    
    

    <macrodef name="solrmarc-index-file" description="Index file or directory" >
        <attribute name="file"/>
        <attribute name="logdir"/>
	<attribute name="suffix"          default=".mrc"/>
        <attribute name="solrmarc.config" default="${solrmarc.config}"/> 
        <attribute name="solr.baseurl"    default="${solr.baseurl}"/>
        <attribute name="solr.core"       default="${solr.core}"/>
        <sequential>
          <var name="basename" unset="true"/>	   
          <basename property="basename" file="@{file}" suffix="@{suffix}"/>
          <java 
              jar="${solrmarc.dist.path}/SolrMarc.jar"
              fork="true" 
              dir="${solrmarc.dist.path}"
              error="@{logdir}/${basename}_err.log"
              output="@{logdir}/${basename}_out.log"
              maxmemory="1G">
            <sysproperty key="solr.hosturl" value="@{solr.baseurl}/@{solr.core}/update"/>
            <sysproperty key="solrmarc.log.level" value="INFO"/>
            <sysproperty key="log4j.configurationFile" value="${basedir}/log4j.properties"/>
            <arg value="@{solrmarc.config}"/>
            <arg value="@{file}"/>
          </java>
        </sequential>
    </macrodef>

    <macrodef name="solrmarc-delete-file" description="Delete records by ID" >
        <attribute name="file"/>
        <attribute name="logdir"/>
        <attribute name="solrmarc.config" default="${solrmarc.config}"/> 
        <attribute name="solr.baseurl"    default="${solr.baseurl}"/>
        <attribute name="solr.core"       default="${solr.core}"/>
        <sequential>
	  <var name="basename" unset="true"/>	   
            <basename property="basename" file="@{file}" suffix=".txt"/>
            <java 
                jar="${solrmarc.dist.path}/SolrMarc.jar"
                fork="true" 
                dir="${solrmarc.dist.path}"
                error="@{logdir}/${basename}_err.log"
                output="@{logdir}/${basename}_out.log"
                maxmemory="1G">
                <sysproperty key="solr.hosturl"            value="@{solr.baseurl}/@{solr.core}/update"/>
                <sysproperty key="solrmarc.log.level"      value="INFO"/>
                <sysproperty key="log4j.configurationFile" value="${basedir}/log4j.properties"/>
                <sysproperty key="marc.ids_to_delete"      value="@{file}"/>
                <arg value="@{solrmarc.config}"/>
                <arg value="NONE"/>
            </java>
        </sequential>
    </macrodef>
    
    <macrodef name="solrmarc-index-dir">
      <attribute name="src"/>
      <attribute name="suffix"          default=".mrc"/>
      <attribute name="logdir"/>
      <sequential>
	<echo>Datadir @{src}</echo>
            <mkdir dir="@{logdir}"/>
            <for param="file">
                <path>
                  <fileset dir="@{src}">
		    <include name="*.mrc"/>
		    <include name="*.xml"/>
		  </fileset>
                </path>
                <sequential>
		  <echo>Indexing @{file}</echo>
                  <solrmarc-index-file file="@{file}" suffix="@{suffix}" logdir="@{logdir}"/>
                </sequential>
            </for>            
        </sequential>
    </macrodef>
    
    <macrodef name="solrmarc-delete-dir">
        <attribute name="src"/>
        <attribute name="logdir"/>
        <sequential>
            <mkdir dir="@{logdir}"/>
            <for param="file">
                <path>
                    <fileset dir="@{src}" includes="*.txt"/>
                </path>
                <sequential>
		  <echo>Delete @{file}</echo>
		  <solrmarc-delete-file file="@{file}" logdir="@{logdir}"/>
                </sequential>
            </for>
        </sequential>
    </macrodef>
    
    <macrodef name="solr-ping">
        <attribute name="action"/>
        <sequential>
            <get src="${solr.baseurl}/${solr.core}/admin/ping?indent=true&amp;action=@{action}" 
                 dest="solr-response.txt" 
                 verbose="true"
                 maxtime="3"
                 retries="3"/>
                 <loadfile property="solr-response.txt" srcFile="solr-response.txt"/>
                 <echo message="solr-response"/>
                 <delete file="solr-response.txt"/>
        </sequential>
    </macrodef>

    <macrodef name="solr-update">
        <attribute name="action"/>
        <sequential>
            <get src="${solr.baseurl}/${solr.core}/update?indent=true&amp;@{action}=true" 
                 dest="solr-response.txt" 
                 verbose="true"
                 maxtime="3"
                 retries="3"/>
                 <loadfile property="solr-response" srcFile="solr-response.txt"/>
                 <echo message="${solr-response}"/>
                 <delete file="solr-response.txt"/>
        </sequential>
    </macrodef>
    
</project>
